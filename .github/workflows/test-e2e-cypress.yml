name: WIP Test / E2E

on:
  workflow_call:
    inputs:
      browser:
        required: false
        type: string
        default: chrome
      theme:
        required: false
        type: string
        default: go
      wpVersion:
        required: false
        type: string
        default: ""

jobs:
  test_e2e:
    name: E2E Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup wp-env
        uses: godaddy-wordpress/setup-wp-env@v1
        with:
          core: ${{ inputs.wpVersion }}
          plugins: '["."]'
          themes: '["https://downloads.wordpress.org/theme/go.zip"]'

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Setup WP-CLI
        uses: godaddy-wordpress/setup-wp-cli@1

      # - name: Install dependencies and build
      #   run: |
      #     npm i -g yarn
      #     composer install --prefer-dist --optimize-autoloader &
      #     yarn install --immutable
      #     yarn build

      - name: Prepare Go
        if: ${{ inputs.theme == 'go' }}
        run: |
          wp-env install-path
          cd $(wp-env install-path)
          ls -lA

      # - name: Prepare tests
      #   run: |
      #     wp-env run cli "wp post generate --count=5"
      #     wp-env run cli "wp theme activate ${{ inputs.theme }}"
      #     wp-env run cli "wp option update permalink_structure '/%postname%'"

      # - name: Run tests
      #   run: |
      #     echo '{"wpUsername":"admin","wpPassword":"password","testURL":"http://localhost:8888"}' | jq . > cypress.env.json
      #     ./node_modules/.bin/cypress verify
      #     ./node_modules/.bin/cypress run --browser ${{ inputs.browser }} --record --parallel --group e2e-${{ inputs.browser }}-wp-${{ inputs.wpVersion }} --headed

